#!/usr/bin/env node

var path = require('path'),
    exec = require('child_process').exec,
    assert = require('assert');

var sleeper = path.join(__dirname, 'sleeper.js');
var ts      = path.join(__dirname, '..', 'bin', 'ts.js');
var command = sleeper + ' | ' + ts;

exec(command, function(error, stdout, stderr) {
    assert.ifError(error);

    assert(stderr.length === 0, 'STDERR is not empty: ' + stderr);
    
    var lines = stdout.split("\n");
    var firstTs     = extractTimestamp(lines.shift());
    var secondTs    = extractTimestamp(lines.shift());
    var thirdTs     = extractTimestamp(lines.shift());
    
    assert.equal(secondTs - firstTs, 1000,
        'The difference between first and second timestamp is not 1 second');
        
    assert.equal(thirdTs - secondTs, 1000,
        'The difference between second and third timestamp is not 1 second');

    console.log('OK');
    process.exit(0);
});

function extractTimestamp(line) {
    var tsLength = 19;
    var tsString = line.substr(1, tsLength);
    return (new Date(tsString)).getTime();
}
